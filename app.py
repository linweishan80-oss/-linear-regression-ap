import streamlit as st
import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error, r2_score
import plotly.express as px

# --- é é¢è¨­å®š ---
st.set_page_config(
    page_title="ç·šæ€§è¿´æ­¸èˆ‡CRISP-DM",
    page_icon="ğŸ“Š",
    layout="wide"
)

# --- CRISP-DM æ¡†æ¶ ---

# 1. å•†æ¥­ç†è§£ (Business Understanding)
st.title("ğŸ“Š éµå¾ªCRISP-DMçš„ç°¡å–®ç·šæ€§è¿´æ­¸")
st.markdown("""
é€™å€‹äº’å‹•å¼Webæ‡‰ç”¨ç¨‹å¼æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ **CRISP-DM (è·¨è¡Œæ¥­è³‡æ–™æ¢å‹˜æ¨™æº–æµç¨‹)** æ–¹æ³•ä¾†è§£æ±ºä¸€å€‹ç°¡å–®çš„ç·šæ€§è¿´æ­¸å•é¡Œã€‚

**ç›®æ¨™ï¼š** å»ºç«‹è‡ªè®Šæ•¸ `X` å’Œæ‡‰è®Šæ•¸ `y` ä¹‹é–“çš„ç·šæ€§é—œä¿‚æ¨¡å‹ã€‚æˆ‘å€‘å°‡ç”Ÿæˆåˆæˆè³‡æ–™ï¼Œä¸¦æ‰¾å‡ºæè¿°è©²è³‡æ–™çš„æœ€ä½³æ“¬åˆç·šã€‚
""")

st.header("1. å•†æ¥­ç†è§£ (Business Understanding)")
st.info("""
**æƒ…å¢ƒ:** æˆ‘å€‘çš„æ¥­å‹™ç›®æ¨™æ˜¯æ ¹æ“šå–®ä¸€å½±éŸ¿å› ç´ ï¼ˆä¾‹å¦‚ï¼šå»£å‘Šæ”¯å‡ºï¼‰ä¾†ç†è§£å’Œé æ¸¬ä¸€å€‹é‡åŒ–çµæœï¼ˆä¾‹å¦‚ï¼šéŠ·å”®é¡ï¼‰ã€‚æˆ‘å€‘éœ€è¦ä¸€å€‹ç°¡å–®ã€å¯è§£é‡‹çš„æ¨¡å‹ä¾†å±•ç¤ºè©²å› ç´ å¦‚ä½•å½±éŸ¿çµæœã€‚

**è¡Œå‹•:** æˆ‘å€‘å°‡ä½¿ç”¨ç°¡å–®ç·šæ€§è¿´æ­¸ (`y = ax + b`) ä¾†å»ºç«‹é€™å€‹æ¨¡å‹ã€‚é€™å€‹Webä»‹é¢å°‡å…è¨±æˆ‘å€‘è§€å¯Ÿåº•å±¤è³‡æ–™é—œä¿‚çš„è®ŠåŒ–å¦‚ä½•å½±éŸ¿æ¨¡å‹çš„æ€§èƒ½ã€‚
""")

# 2. è³‡æ–™ç†è§£ (Data Understanding)
st.header("2. è³‡æ–™ç†è§£ (Data Understanding)")
st.markdown("""
**æƒ…å¢ƒ:** åœ¨å»ºç«‹æ¨¡å‹ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦è³‡æ–™ã€‚æˆ‘å€‘éœ€è¦äº†è§£å®ƒçš„ä¾†æºã€çµæ§‹ä»¥åŠå®šç¾©å®ƒçš„å› ç´ ã€‚

**è¡Œå‹•:** åœ¨é€™å€‹ç¤ºç¯„ä¸­ï¼Œæˆ‘å€‘å°‡ç”Ÿæˆåˆæˆè³‡æ–™ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å´é‚Šæ¬„ä¾†æ§åˆ¶è³‡æ–™ç”Ÿæˆçš„åƒæ•¸ã€‚é€™ä½¿æˆ‘å€‘èƒ½å¤ æ¢ç´¢æ¨¡å‹åœ¨ä¸åŒæ¢ä»¶ä¸‹çš„è¡Œç‚ºã€‚
""")

# --- å´é‚Šæ¬„ä½¿ç”¨è€…è¼¸å…¥ ---
st.sidebar.header("âš™ï¸ è³‡æ–™ç”Ÿæˆåƒæ•¸")
st.sidebar.markdown("ä¿®æ”¹é€™äº›å€¼ä»¥è§€å¯Ÿå®ƒå€‘å¦‚ä½•å½±éŸ¿è³‡æ–™å’Œæ¨¡å‹æ€§èƒ½ã€‚")

# å…è¨±ä½¿ç”¨è€…ä¿®æ”¹åƒæ•¸
a_true = st.sidebar.slider("æ–œç‡ (a)", min_value=-10.0, max_value=10.0, value=2.5, step=0.1)
noise_level = st.sidebar.slider("é›œè¨Šç­‰ç´š", min_value=0.0, max_value=10.0, value=2.0, step=0.5)
n_points = st.sidebar.slider("è³‡æ–™é»æ•¸é‡", min_value=50, max_value=1000, value=200, step=50)
b_true = 5.0 # ç‚ºç°¡åŒ–èµ·è¦‹ï¼Œæˆªè·bè¨­ç‚ºå›ºå®šå€¼

# 3. è³‡æ–™æº–å‚™ (Data Preparation)
st.header("3. è³‡æ–™æº–å‚™ (Data Preparation)")
st.markdown("""
**æƒ…å¢ƒ:** åŸå§‹è³‡æ–™éœ€è¦ç‚ºæ¨¡å‹å»ºç«‹åšæº–å‚™ã€‚é€™åŒ…æ‹¬æ ¹æ“šæˆ‘å€‘çš„ç†è§£ç”Ÿæˆè³‡æ–™ã€æ­£ç¢ºæ ¼å¼åŒ–ä»¥åŠå°‡å…¶åˆ†å‰²ç‚ºè¨“ç·´é›†å’Œæ¸¬è©¦é›†ã€‚

**è¡Œå‹•:**
1.  æ ¹æ“šå…¬å¼ `y = a*X + b + noise` ç”Ÿæˆ `X` å’Œ `y` çš„å€¼ã€‚
2.  å°‡è³‡æ–™å„²å­˜åœ¨ Pandas DataFrame ä¸­ä»¥ä¾¿æ–¼æ“ä½œã€‚
3.  åˆ†å‰²è³‡æ–™ï¼š80% ç”¨æ–¼è¨“ç·´æ¨¡å‹ï¼Œ20% ç”¨æ–¼è©•ä¼°å…¶åœ¨æœªè¦‹éçš„è³‡æ–™ä¸Šçš„æ€§èƒ½ã€‚
""")

# ç”Ÿæˆè³‡æ–™
np.random.seed(42) # ç‚ºäº†å¯é‡ç¾æ€§
X = 2 * np.random.rand(n_points, 1)
y = b_true + a_true * X + np.random.randn(n_points, 1) * noise_level
df = pd.DataFrame(data={'X': X.flatten(), 'y': y.flatten()})

# é¡¯ç¤ºè³‡æ–™ç¯„ä¾‹
with st.expander("é»æ“ŠæŸ¥çœ‹ç”Ÿæˆè³‡æ–™çš„ç¯„ä¾‹"):
    st.write(df.head())

# åˆ†å‰²è³‡æ–™
X_train, X_test, y_train, y_test = train_test_split(df[['X']], df['y'], test_size=0.2, random_state=42)
st.write(f"è³‡æ–™å·²åˆ†å‰²ç‚º **{len(X_train)} ç­†è¨“ç·´æ¨£æœ¬** å’Œ **{len(y_test)} ç­†æ¸¬è©¦æ¨£æœ¬**ã€‚")


# 4. æ¨¡å‹å»ºç«‹ (Modeling)
st.header("4. æ¨¡å‹å»ºç«‹ (Modeling)")
st.markdown("""
**æƒ…å¢ƒ:** ç¾åœ¨æˆ‘å€‘é¸æ“‡ä¸¦æ‡‰ç”¨ä¸€ç¨®åˆé©çš„å»ºæ¨¡æŠ€è¡“ã€‚

**è¡Œå‹•:** æˆ‘å€‘å°‡ä½¿ç”¨ Scikit-learn å‡½å¼åº«ä¸­çš„ `LinearRegression` æ¨¡å‹ï¼Œä¸¦ç”¨æˆ‘å€‘çš„è¨“ç·´è³‡æ–™ä¾†è¨“ç·´å®ƒã€‚æ¨¡å‹å°‡å¾è³‡æ–™ä¸­å­¸ç¿’æœ€ä½³çš„æˆªè· (b) å’Œä¿‚æ•¸ (a)ã€‚
""")

# è¨“ç·´æ¨¡å‹
model = LinearRegression()
model.fit(X_train, y_train)

learned_b = model.intercept_
learned_a = model.coef_[0]

st.write("æ¨¡å‹å·²ç¶“è¨“ç·´å®Œæˆã€‚ä»¥ä¸‹æ˜¯å­¸ç¿’åˆ°çš„åƒæ•¸ï¼š")
col1, col2 = st.columns(2)
col1.metric(label="å­¸ç¿’åˆ°çš„æˆªè· (b)", value=f"{learned_b:.2f}", delta=f"{learned_b - b_true:.2f} èˆ‡çœŸå¯¦å€¼çš„å·®ç•°")
col2.metric(label="å­¸ç¿’åˆ°çš„ä¿‚æ•¸ (a)", value=f"{learned_a:.2f}", delta=f"{learned_a - a_true:.2f} èˆ‡çœŸå¯¦å€¼çš„å·®ç•°")


# 5. æ¨¡å‹è©•ä¼° (Evaluation)
st.header("5. æ¨¡å‹è©•ä¼° (Evaluation)")
st.markdown("""
**æƒ…å¢ƒ:** æˆ‘å€‘éœ€è¦è©•ä¼°æˆ‘å€‘çš„æ¨¡å‹è¡¨ç¾å¦‚ä½•ï¼Œä»¥åŠå®ƒæ˜¯å¦æ»¿è¶³æ¥­å‹™ç›®æ¨™ã€‚

**è¡Œå‹•:**
1.  ä½¿ç”¨è¨“ç·´å¥½çš„æ¨¡å‹å°æœªè¦‹éçš„æ¸¬è©¦è³‡æ–™é€²è¡Œé æ¸¬ã€‚
2.  è¨ˆç®—è©•ä¼°æŒ‡æ¨™ï¼š
    - **å‡æ–¹èª¤å·® (MSE):** è¡¡é‡å¯¦éš›å€¼èˆ‡é æ¸¬å€¼ä¹‹é–“å¹³å‡å¹³æ–¹å·®ã€‚è¶Šä½è¶Šå¥½ã€‚
    - **Rå¹³æ–¹ (RÂ²):** ä»£è¡¨æ‡‰è®Šæ•¸çš„è®Šç•°ä¸­ï¼Œå¯ç”±è‡ªè®Šæ•¸é æ¸¬çš„æ¯”ä¾‹ã€‚è¶Šæ¥è¿‘1è¶Šå¥½ã€‚
3.  é€éç¹ªè£½åŸå§‹è³‡æ–™é»å’Œæ¨¡å‹çš„è¿´æ­¸ç·šä¾†å°‡çµæœè¦–è¦ºåŒ–ã€‚
""")

# é€²è¡Œé æ¸¬
y_pred = model.predict(X_test)

# è¨ˆç®—æŒ‡æ¨™
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)

st.write("æ¨¡å‹åœ¨æ¸¬è©¦è³‡æ–™ä¸Šçš„è¡¨ç¾ï¼š")
col1, col2 = st.columns(2)
col1.metric(label="å‡æ–¹èª¤å·® (MSE)", value=f"{mse:.2f}")
col2.metric(label="Rå¹³æ–¹ (RÂ²)", value=f"{r2:.2f}")

# è¦–è¦ºåŒ–
st.subheader("è¦–è¦ºåŒ–è©•ä¼°")
st.markdown("ä¸‹åœ–é¡¯ç¤ºäº†åŸå§‹è³‡æ–™é»ï¼Œç´…ç·šå‰‡ä»£è¡¨æˆ‘å€‘å­¸ç¿’åˆ°çš„è¿´æ­¸æ¨¡å‹ã€‚")

# ç‚ºXçš„æ•´å€‹ç¯„åœå‰µå»ºä¸€æ¢é æ¸¬ç·š
X_range = np.array([[df['X'].min()], [df['X'].max()]])
y_line = model.predict(X_range)

# ä½¿ç”¨ Plotly ç¹ªåœ–
fig = px.scatter(df, x='X', y='y', title="ç·šæ€§è¿´æ­¸æ“¬åˆçµæœ", labels={'X': 'è‡ªè®Šæ•¸ (X)', 'y': 'æ‡‰è®Šæ•¸ (y)'})
fig.add_scatter(x=X_range.flatten(), y=y_line.flatten(), mode='lines', name='è¿´æ­¸ç·š', line=dict(color='red', width=3))
st.plotly_chart(fig, use_container_width=True)


# 6. éƒ¨ç½² (Deployment)
st.header("6. éƒ¨ç½² (Deployment)")
st.success("""
**æƒ…å¢ƒ:** æ¨¡å‹å·²ç¶“æº–å‚™å¥½äº†ã€‚æˆ‘å€‘å¦‚ä½•å°‡å…¶æä¾›çµ¦çµ‚ç«¯ä½¿ç”¨è€…ï¼Ÿ

**è¡Œå‹•:** é€™å€‹Streamlitæ‡‰ç”¨ç¨‹å¼æœ¬èº«å°±æ˜¯éƒ¨ç½²ï¼å®ƒç‚ºä½¿ç”¨è€…ï¼ˆä¾‹å¦‚æ‚¨ï¼‰æä¾›äº†ä¸€å€‹äº’å‹•ä»‹é¢ï¼Œå¯ä»¥å³æ™‚ä½¿ç”¨æ¨¡å‹ã€ç”Ÿæˆæ–°è³‡æ–™ä¸¦è©•ä¼°çµæœã€‚

è¦åœ¨æ‚¨è‡ªå·±çš„æ©Ÿå™¨ä¸Šé‹è¡Œæ­¤æ‡‰ç”¨ç¨‹å¼ï¼Œè«‹å°‡ä»£ç¢¼å¦å­˜ç‚º `app.py`ï¼Œå®‰è£æ‰€éœ€çš„å‡½å¼åº«ï¼Œç„¶å¾Œåœ¨æ‚¨çš„çµ‚ç«¯æ©Ÿä¸­é‹è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
""")
st.code("streamlit run app.py", language="bash")